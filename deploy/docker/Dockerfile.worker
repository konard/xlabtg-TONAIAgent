# TON AI Agent - Worker Dockerfile
#
# Background worker for strategy execution, AI processing, and blockchain operations
#
# Build: docker build -f Dockerfile.worker -t tonaiagent-worker:latest .
# Run: docker run --env-file .env tonaiagent-worker:latest

# ============================================
# Stage 1: Dependencies
# ============================================
FROM node:20-alpine AS deps

WORKDIR /app

RUN apk add --no-cache python3 make g++

COPY package.json package-lock.json* ./
RUN npm ci --only=production && npm cache clean --force

# ============================================
# Stage 2: Builder
# ============================================
FROM node:20-alpine AS builder

WORKDIR /app

COPY --from=deps /app/node_modules ./node_modules
COPY package.json package-lock.json* ./
RUN npm ci

COPY . .
RUN npm run build

# ============================================
# Stage 3: Production Runtime
# ============================================
FROM node:20-alpine AS runner

WORKDIR /app

RUN addgroup --system --gid 1001 tonaiagent && \
    adduser --system --uid 1001 tonaiagent

RUN apk add --no-cache curl dumb-init

COPY --from=deps --chown=tonaiagent:tonaiagent /app/node_modules ./node_modules
COPY --from=builder --chown=tonaiagent:tonaiagent /app/dist ./dist
COPY --from=builder --chown=tonaiagent:tonaiagent /app/package.json ./

ENV NODE_ENV=production
ENV WORKER_MODE=true

# Health check for workers
HEALTHCHECK --interval=60s --timeout=30s --start-period=10s --retries=3 \
    CMD node -e "process.exit(0)" || exit 1

USER tonaiagent

ENTRYPOINT ["dumb-init", "--"]

# Start the worker process
CMD ["node", "dist/worker.js"]
