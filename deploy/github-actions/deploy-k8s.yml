# TON AI Agent - Kubernetes Deployment
#
# Deploys to Kubernetes using Helm.
#
# Required secrets:
#   KUBE_CONFIG - Base64 encoded kubeconfig
#   HELM_VALUES - Base64 encoded values file (optional)

name: Deploy to Kubernetes

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

env:
  NAMESPACE: tonaiagent
  RELEASE_NAME: tonaiagent
  CHART_PATH: deploy/kubernetes/helm/tonaiagent

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Configure Kubernetes credentials
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Add Bitnami repo
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Lint Helm chart
        run: |
          helm lint ${{ env.CHART_PATH }}

      - name: Get image tag
        id: image-tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Decode Helm values (if provided)
        if: secrets.HELM_VALUES != ''
        run: |
          echo "${{ secrets.HELM_VALUES }}" | base64 -d > values-secrets.yaml

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ env.RELEASE_NAME }} ${{ env.CHART_PATH }} \
            --namespace ${{ env.NAMESPACE }} \
            --create-namespace \
            --set app.image.tag=${{ steps.image-tag.outputs.tag }} \
            --set worker.image.tag=${{ steps.image-tag.outputs.tag }} \
            ${{ secrets.HELM_VALUES && '-f values-secrets.yaml' || '' }} \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/${{ env.RELEASE_NAME }} -n ${{ env.NAMESPACE }}
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=tonaiagent

      - name: Run smoke tests
        run: |
          # Get the service URL
          SERVICE_IP=$(kubectl get svc ${{ env.RELEASE_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

          if [ -z "$SERVICE_IP" ]; then
            echo "Using port-forward for testing..."
            kubectl port-forward svc/${{ env.RELEASE_NAME }} 8080:80 -n ${{ env.NAMESPACE }} &
            sleep 5
            SERVICE_URL="http://localhost:8080"
          else
            SERVICE_URL="http://$SERVICE_IP"
          fi

          # Health check
          response=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/health")

          if [ "$response" == "200" ]; then
            echo "Health check passed!"
          else
            echo "Health check failed with status: $response"
            exit 1
          fi

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "Deployment failed, checking pod logs..."
          kubectl logs -l app.kubernetes.io/name=tonaiagent -n ${{ env.NAMESPACE }} --tail=100
